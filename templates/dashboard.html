{% extends "base.html" %}

{% block content %}
  <header>
    <div id="status">
      <div id="personal">
        {% if user is none %}
          <a class="btn0" href="/login">login</a>
          <a class="btn0" href="/register">register</a>
        {% else %}
          <div class="dropdown">
            <button class="btn0">{{ user.username }}</button>
            <div class="dropdown-content">
              <a class="btn0" href="/reset-password">Change password</a>
              <a class="btn0" href="/delete-account">Delete account</a>
              <form method="post" action="/logout">
                <button class="btn0" type="submit">Logout</button>
              </form>
            </div>
          </div>
          <a class="btn0" href="/">store</a>
          <a class="btn0" href="/promo">promo</a>
        {% endif %}
      </div>
      <div id="other">
        <p id="course">1 XMR = ${{ course }}</p>
      </div>
    </div>
  </header>
  <main>
    <div id="servers">
      <table>
        <tr>
          <th>IPv4</th>
          <th>Status</th>
          <th>Days</th>
        </tr>
        {% for server, status in servers_and_statuses %}
          <tr>
            <td>{% if server.ipv4 %} {{ server.ipv4 }} {% else %} - {% endif %}</td>
            <td id="status-{{ server.id }}">{{ status }}</td>
            <td>{{ server.end_at|to_days }}</td>
            <td>
              <form method="post" action="/api/server/action/{{ server.id }}">
                <button class="btn0" style="display: contents" type="submit">power</button>
              </form>
            </td>
            <td><a class="btn0" style="display: contents" href="/install/{{ server.id }}">install</a></td>
            <td><a class="btn0" style="display: contents" href="/vnc/{{ server.id }}">vnc</a></td>
            <td><a class="btn0" style="display: contents" href="/pay/{{ server.id }}">pay</a></td>
            <td><a class="btn0" style="display: contents" href="/upgrademenu/{{ server.id }}">upgrade</a></td>
          </tr>
          <script>
            const socket{{ server.id }} = new WebSocket(`${window.location.protocol === "https:" ? "wss" : "ws"}://${window.location.host}/api/server/status/{{ server.id }}`);
            socket{{ server.id }}.onmessage = async (event) => { document.getElementById("status-{{ server.id }}").innerText = event.data; };
            socket{{ server.id }}.onerror = (error) => { document.getElementById("status-{{ server.id }}").innerText = "unknown" };
          </script>
        {% endfor %}
      </table>
    </div>
  </main>
{% endblock %}
